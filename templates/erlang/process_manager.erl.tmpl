%%% Process Manager: React to {{source_event}} facts
%%% Action: {{action}} {{target}}
%%% Domain: {{domain}} (target domain)
%%%
%%% Naming: on_{source_event}_{action}_{target}

-module(on_{{source_event}}_{{action}}_{{target}}).

-export([handle/1]).

-spec handle(map()) -> ok | {error, term()}.
handle(FactData) ->
    Params = extract_params(FactData),
    Result = do_action(Params),
    log_result(maps:get({{target}}_id, Params, <<"unknown">>), Result),
    Result.

%%====================================================================
%% Internal
%%====================================================================

extract_params(FactData) ->
    #{
        {{target}}_id => get_field({{target}}_id, FactData)
        %% TODO: extract additional fields from fact
    }.

do_action(Params) ->
    with_command({{target_command}}_v1:new(Params)).

with_command({ok, Cmd}) ->
    dispatch(maybe_{{target_command}}:dispatch(Cmd));
with_command({error, _} = Error) ->
    Error.

dispatch({ok, _Version, _Events}) -> ok;
dispatch({error, _} = Error) -> Error.

log_result(Id, ok) ->
    logger:info("[policy] {{target}} ~s processed via {{source_event}}", [Id]);
log_result(Id, {error, Reason}) ->
    logger:error("[policy] Failed to process {{target}} ~s: ~p", [Id, Reason]).

%% Get field from map supporting both atom and binary keys
get_field(Key, Map) when is_atom(Key) ->
    BinKey = atom_to_binary(Key, utf8),
    maps:get(Key, Map, maps:get(BinKey, Map, undefined)).
