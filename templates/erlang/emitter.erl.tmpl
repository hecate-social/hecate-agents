%%% Emitter: {{event}}_v1 -> mesh
%%% Topic: hecate.{{domain_noun}}.{{event}}
%%% Domain: {{domain}}

-module({{event}}_to_mesh).
-behaviour(gen_server).

-export([start_link/0]).
-export([init/1, handle_call/3, handle_cast/2, handle_info/2, terminate/2]).

-include_lib("kernel/include/logger.hrl").

-define(TOPIC, <<"hecate.{{domain_noun}}.{{event}}">>).

%%====================================================================
%% API
%%====================================================================

start_link() ->
    gen_server:start_link({local, ?MODULE}, ?MODULE, [], []).

%%====================================================================
%% gen_server callbacks
%%====================================================================

init([]) ->
    ok = reckon_evoq:subscribe({{domain}}_store, self(), #{
        event_types => [<<"{{event}}_v1">>]
    }),
    ?LOG_INFO("[~s] Emitter started, publishing to ~s", [?MODULE, ?TOPIC]),
    {ok, #{}}.

handle_call(_Request, _From, State) ->
    {reply, {error, not_implemented}, State}.

handle_cast(_Msg, State) ->
    {noreply, State}.

handle_info({evoq_event, _StreamId, EventType, EventData, _Position}, State)
  when EventType =:= <<"{{event}}_v1">> ->
    Fact = event_to_fact(EventData),
    ok = hecate_mesh:publish(?TOPIC, Fact),
    ?LOG_DEBUG("[~s] Published FACT to ~s", [?MODULE, ?TOPIC]),
    {noreply, State};

handle_info(_Info, State) ->
    {noreply, State}.

terminate(_Reason, _State) ->
    ok.

%%====================================================================
%% Internal
%%====================================================================

%% Transform internal EVENT to external FACT
%% FACT is a PUBLIC CONTRACT - may differ from EVENT structure
event_to_fact(EventData) ->
    #{
        {{aggregate}}_id => maps:get(<<"{{aggregate}}_id">>, EventData),
        %% TODO: select fields for public contract
        published_at => erlang:system_time(millisecond)
    }.
