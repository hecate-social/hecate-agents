%%% API handler: {{command}}
%%% Route: POST /api/{{route_path}}
%%% Domain: {{domain}}

-module({{command}}_api).
-export([init/2]).

init(Req0, State) ->
    case cowboy_req:method(Req0) of
        <<"POST">> -> handle_post(Req0, State);
        _ -> hecate_api_utils:method_not_allowed(Req0)
    end.

handle_post(Req0, _State) ->
    case hecate_api_utils:read_json_body(Req0) of
        {ok, Params, Req1} ->
            do_command(Params, Req1);
        {error, invalid_json, Req1} ->
            hecate_api_utils:bad_request(<<"Invalid JSON">>, Req1)
    end.

do_command(Params, Req) ->
    CmdParams = #{
        {{aggregate}}_id => maps:get(<<"{{aggregate}}_id">>, Params, undefined)
        %% TODO: Extract additional fields from Params
    },
    case {{command}}_v1:new(CmdParams) of
        {ok, Cmd} ->
            dispatch_result(maybe_{{command}}:dispatch(Cmd), Req);
        {error, Reason} ->
            hecate_api_utils:json_error(400, Reason, Req)
    end.

dispatch_result({ok, Version, Events}, Req) ->
    hecate_api_utils:json_ok(201, #{version => Version, events => Events}, Req);
dispatch_result({error, Reason}, Req) ->
    hecate_api_utils:json_error(400, Reason, Req).
