%%% Query: get a page of {{aggregates}}
%%% Domain: query_{{aggregates}}

-module(get_{{aggregates}}_page).

-include_lib("{{cmd_domain}}/include/{{aggregate}}_status.hrl").

-export([execute/1]).

-define(DEFAULT_PAGE_SIZE, 50).
-define(MAX_PAGE_SIZE, 200).

-spec execute(map()) -> {ok, map()} | {error, term()}.
execute(Opts) ->
    Page = maps:get(page, Opts, 1),
    PageSize = min(maps:get(page_size, Opts, ?DEFAULT_PAGE_SIZE), ?MAX_PAGE_SIZE),
    Offset = (Page - 1) * PageSize,

    CountSql = "SELECT COUNT(*) FROM {{aggregates}} WHERE (status & ?1) = 0",
    {ok, [[Total]]} = query_{{aggregates}}_store:query(CountSql, [?{{AGGREGATE_UPPER}}_ARCHIVED]),

    Sql = "SELECT {{aggregate}}_id, name, status, status_label, initiated_at "
          "FROM {{aggregates}} "
          "WHERE (status & ?1) = 0 "
          "ORDER BY initiated_at DESC "
          "LIMIT ?2 OFFSET ?3",
    case query_{{aggregates}}_store:query(Sql, [?{{AGGREGATE_UPPER}}_ARCHIVED, PageSize, Offset]) of
        {ok, Rows} ->
            {ok, #{
                items => [row_to_map(R) || R <- Rows],
                total => Total,
                page => Page,
                page_size => PageSize
            }};
        {error, Reason} ->
            {error, Reason}
    end.

row_to_map([Id, Name, Status, StatusLabel, InitiatedAt]) ->
    #{
        {{aggregate}}_id => Id,
        name => Name,
        status => Status,
        status_label => StatusLabel,
        initiated_at => InitiatedAt
    }.
