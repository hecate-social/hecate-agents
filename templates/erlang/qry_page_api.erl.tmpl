%%% API handler: paged list of {{aggregates}}
%%% Route: GET /api/{{aggregates}}

-module(get_{{aggregates}}_page_api).
-export([init/2]).

init(Req0, State) ->
    case cowboy_req:method(Req0) of
        <<"GET">> -> handle_get(Req0, State);
        _ -> hecate_api_utils:method_not_allowed(Req0)
    end.

handle_get(Req0, _State) ->
    QS = cowboy_req:parse_qs(Req0),
    Opts = parse_pagination(QS),
    case get_{{aggregates}}_page:execute(Opts) of
        {ok, Result} ->
            hecate_api_utils:json_ok(Result, Req0);
        {error, Reason} ->
            hecate_api_utils:json_error(500, Reason, Req0)
    end.

parse_pagination(QS) ->
    lists:foldl(fun({K, V}, Acc) ->
        case K of
            <<"page">> ->
                case catch binary_to_integer(V) of
                    I when is_integer(I), I > 0 -> Acc#{page => I};
                    _ -> Acc
                end;
            <<"page_size">> ->
                case catch binary_to_integer(V) of
                    I when is_integer(I), I > 0 -> Acc#{page_size => I};
                    _ -> Acc
                end;
            _ -> Acc
        end
    end, #{}, QS).
