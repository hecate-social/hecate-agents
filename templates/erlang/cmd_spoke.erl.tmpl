%%% Command desk: {{command}} v1
%%% Domain: {{domain}}
%%% Event: {{event}}_v1

%% --- {{command}}_v1.erl ---

-module({{command}}_v1).

-export([new/1, to_map/1, from_map/1]).
-export([stream_id/1]).
-export([{{aggregate}}_id/1]).

-record({{command}}_v1, {
    {{aggregate}}_id :: binary(),
    %% TODO: add fields from event storming
    command_type :: binary()
}).

-opaque t() :: #{{command}}_v1{}.
-export_type([t/0]).

new(#{{{aggregate}}_id := Id} = Params) ->
    {ok, #{{command}}_v1{
        {{aggregate}}_id = Id,
        command_type = <<"{{command}}">>
    }};
new(_) ->
    {error, missing_required_fields}.

stream_id(#{{command}}_v1{{{aggregate}}_id = Id}) ->
    <<"{{aggregate}}-", Id/binary>>.

to_map(#{{command}}_v1{} = Cmd) ->
    #{
        command_type => Cmd#{{command}}_v1.command_type,
        {{aggregate}}_id => Cmd#{{command}}_v1.{{aggregate}}_id
    }.

from_map(#{<<"{{aggregate}}_id">> := Id} = Map) ->
    {ok, #{{command}}_v1{
        {{aggregate}}_id = Id,
        command_type = maps:get(<<"command_type">>, Map, <<"{{command}}">>)
    }}.

{{aggregate}}_id(#{{command}}_v1{{{aggregate}}_id = V}) -> V.

%% --- {{event}}_v1.erl ---

-module({{event}}_v1).

-export([new/1, from_command/1, to_map/1, from_map/1]).
-export([event_type/0]).
-export([{{aggregate}}_id/1, timestamp/1]).

-record({{event}}_v1, {
    {{aggregate}}_id :: binary(),
    %% TODO: add fields from event storming
    timestamp :: integer()
}).

-opaque t() :: #{{event}}_v1{}.
-export_type([t/0]).

event_type() -> <<"{{event}}_v1">>.

from_command(Cmd) ->
    #{{event}}_v1{
        {{aggregate}}_id = {{command}}_v1:{{aggregate}}_id(Cmd),
        timestamp = erlang:system_time(millisecond)
    }.

new(#{{{aggregate}}_id := Id}) ->
    #{{event}}_v1{
        {{aggregate}}_id = Id,
        timestamp = erlang:system_time(millisecond)
    }.

to_map(#{{event}}_v1{} = E) ->
    #{
        event_type => event_type(),
        {{aggregate}}_id => E#{{event}}_v1.{{aggregate}}_id,
        timestamp => E#{{event}}_v1.timestamp
    }.

from_map(#{<<"{{aggregate}}_id">> := Id} = Map) ->
    #{{event}}_v1{
        {{aggregate}}_id = Id,
        timestamp = maps:get(<<"timestamp">>, Map, 0)
    }.

{{aggregate}}_id(#{{event}}_v1{{{aggregate}}_id = V}) -> V.
timestamp(#{{event}}_v1{timestamp = V}) -> V.

%% --- maybe_{{command}}.erl ---

-module(maybe_{{command}}).

-export([handle/1, dispatch/1]).

-include_lib("kernel/include/logger.hrl").

dispatch(Cmd) ->
    StreamId = {{command}}_v1:stream_id(Cmd),
    case handle(Cmd) of
        {ok, Event} ->
            EventMap = {{event}}_v1:to_map(Event),
            EventType = {{event}}_v1:event_type(),
            ok = reckon_evoq:append({{domain}}_store, StreamId, EventType, EventMap),
            {ok, Event};
        {error, _} = Error ->
            Error
    end.

handle(Cmd) ->
    case validate(Cmd) of
        ok ->
            Event = {{event}}_v1:from_command(Cmd),
            {ok, Event};
        {error, _} = Error ->
            Error
    end.

validate(_Cmd) ->
    %% TODO: Add validation rules
    ok.
